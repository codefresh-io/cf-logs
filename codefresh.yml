version: '1.0'
steps:

  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: codefresh-io/cf-logs
    working_directory: ./
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
    dockerfile: Dockerfile

  RunningUnitTests:
    title: Running Unit Tests
    image: '${{BuildingDockerImage}}'
    working_directory: IMAGE_WORK_DIR
    entry_point:
    - /bin/sh
    - /codefresh/volume/cf-generated/unit_test_script
    create_file:
      path: /codefresh/volume/cf-generated
      name: unit_test_script
      content: |-
        gulp lint
        gulp no.onlys
        gulp unit_test
        gulp clean
    on_success:
      metadata:
        set:
        - '${{BuildingDockerImage.imageId}}':
          - CF_QUALITY: true
    on_fail:
      metadata:
        set:
        - '${{BuildingDockerImage.imageId}}':
          - CF_QUALITY: false

  deploy_to_npm:
    title: Publishing To Npm
    image: codefresh/node-tester-image:10.13.0
    commands:
      - NPM_TOKEN=${{NPM_TOKEN}} npm run ci-publish
    when:
      branch:
        only: [ master ]
